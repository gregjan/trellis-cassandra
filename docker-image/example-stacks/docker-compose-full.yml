version: "3"
# https://forums.docker.com/t/cassandra-on-docker-swarm/27923/3 - placement ideas
# https://github.com/thelastpickle/docker-cassandra-bootstrap - monitoring/grafana, other docker details
services:
  trellis-cassandra:
    image: trellisldp/trellis-cassandra:${SUBJECT_DOCKER_TAG:?SUBJECT_DOCKER_TAG missing}
    environment:
      CASSANDRA_CONTACT_ADDRESS: "cassandra-1"
      CASSANDRA_CONTACT_PORT: 9042
      CASSANDRA_MAX_CHUNK_SIZE:
      CASSANDRA_BINARY_READ_CONSISTENCY:
      CASSANDRA_BINARY_WRITE_CONSISTENCY:
      CASSANDRA_RDF_READ_CONSISTENCY:
      CASSANDRA_RDF_WRITE_CONSISTENCY:
      TRELLIS_JMS_USE_QUEUE: ${TRELLIS_JMS_USE_QUEUE:?TRELLIS_JMS_USE_QUEUE missing}
      TRELLIS_JMS_QUEUE_NAME: "trellis"
      TRELLIS_JMS_URL: "tcp://activemq:61616"
      TRELLIS_JMS_USERNAME:
      TRELLIS_JMS_PASSWORD:
    volumes:
      - ./users.auth:/etc/users.auth
    ports:
      - "10080:8080"
    deploy:
      mode: replicated
      replicas: ${FRONTEND_NODES:?FRONTEND_NODES missing}
      restart_policy:
        condition: on-failure
        max_attempts: 20
        window: 120s
    links:
      - cassandra-1
      - cassandra-2
      - cassandra-3
      - activemq
    depends_on:
      - cassandra-1
      - cassandra-2
      - cassandra-3
      - activemq
  activemq:
    image: rmohr/activemq:latest
    ports:
      - "61616:61616"
    deploy:
      restart_policy:
        condition: on-failure
        max_attempts: 20
        window: 120s
  cassandra-1:
    image: cassandra
    environment:
      CASSANDRA_BROADCAST_ADDRESS: cassandra-1
    links:
      - cassandra-2
      - cassandra-3
    deploy:
      restart_policy:
        condition: on-failure
        max_attempts: 3
        window: 120s
  cassandra-2:
    image: cassandra
    environment:
      CASSANDRA_BROADCAST_ADDRESS: cassandra-2
      CASSANDRA_SEEDS: cassandra-1
    links:
      - cassandra-1
      - cassandra-3
    deploy:
      restart_policy:
        condition: on-failure
        max_attempts: 3
        window: 120s
    depends_on:
      - cassandra-1
  cassandra-3:
    image: cassandra
    environment:
      CASSANDRA_BROADCAST_ADDRESS: cassandra-3
      CASSANDRA_SEEDS: cassandra-1
    links:
      - cassandra-1
      - cassandra-2
    deploy:
      restart_policy:
        condition: on-failure
        max_attempts: 3
        window: 120s
    depends_on:
      - cassandra-2
  cassandra-init:
    image: trellisldp/trellis-cassandra-init:0.8.1-SNAPSHOT
    depends_on:
      - cassandra-3
    links:
      - cassandra-1
    deploy:
      restart_policy:
        condition: on-failure
        delay: 30s
    command: cqlsh cassandra-1 -f /load.cql && cqlsh -e "ALTER KEYSPACE trellis WITH REPLICATION = {'class' : 'SimpleStrategy', 'replication_factor' : ${CASSANDRA_REPLICATION_FACTOR:?CASSANDRA_REPLICATION_FACTOR}}" cassandra-1
}"
